# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é Replay Service

## –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –ø–æ–∫—Ä—ã—Ç —Ç—Ä–µ–º—è —Ç–∏–ø–∞–º–∏ —Ç–µ—Å—Ç–æ–≤:

1. **Unit-—Ç–µ—Å—Ç—ã (Services)** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ —Å –º–æ–∫–∞–º–∏
2. **Integration-—Ç–µ—Å—Ç—ã (Repository)** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
3. **HTTP-—Ç–µ—Å—Ç—ã (Handlers)** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
server/internal/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ game.go
‚îÇ   ‚îú‚îÄ‚îÄ game_test.go          # Unit-—Ç–µ—Å—Ç—ã –¥–ª—è GameService
‚îÇ   ‚îú‚îÄ‚îÄ replay.go
‚îÇ   ‚îî‚îÄ‚îÄ replay_test_test.go   # Unit-—Ç–µ—Å—Ç—ã –¥–ª—è ReplayService
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îú‚îÄ‚îÄ game.go
‚îÇ   ‚îú‚îÄ‚îÄ game_test.go          # Integration-—Ç–µ—Å—Ç—ã –¥–ª—è GameRepository
‚îÇ   ‚îú‚îÄ‚îÄ replay.go
‚îÇ   ‚îî‚îÄ‚îÄ replay_test.go        # Integration-—Ç–µ—Å—Ç—ã –¥–ª—è ReplayRepository
‚îî‚îÄ‚îÄ handlers/
    ‚îú‚îÄ‚îÄ game.go
    ‚îú‚îÄ‚îÄ game_test.go          # HTTP-—Ç–µ—Å—Ç—ã –¥–ª—è Game handlers
    ‚îú‚îÄ‚îÄ replay.go
    ‚îî‚îÄ‚îÄ replay_test.go        # HTTP-—Ç–µ—Å—Ç—ã –¥–ª—è Replay handlers (TODO)
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:

```bash
go get github.com/stretchr/testify/assert
go get github.com/stretchr/testify/mock
go get github.com/stretchr/testify/require
```

–≠—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ `go.mod`.

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –í—Å–µ —Ç–µ—Å—Ç—ã

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
go test ./...

# –° –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
go test -v ./...

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
go test -cover ./...

# –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### –¢–æ–ª—å–∫–æ Unit-—Ç–µ—Å—Ç—ã (–±–µ–∑ –ë–î)

Unit-—Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–æ –∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –ë–î:

```bash
# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
go test ./server/internal/services/...

# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã handlers
go test ./server/internal/handlers/...

# –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã)
go test -short ./...
```

### –¢–æ–ª—å–∫–æ Integration-—Ç–µ—Å—Ç—ã (—Å –ë–î)

Integration-—Ç–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∑–∞–ø—É—â–µ–Ω–Ω—É—é PostgreSQL:

```bash
# –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ë–î
docker compose up -d postgres

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
go test ./server/internal/repository/...

# –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Ç–µ—Å—Ç—ã (–≤–∫–ª—é—á–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ)
go test ./...
```

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–¥–∏–Ω —Ç–µ—Å—Ç –ø–æ –∏–º–µ–Ω–∏
go test -v ./server/internal/services -run TestGetUserGames_Success

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ "Create" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
go test -v ./... -run Create
```

## üéØ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Ç–µ—Å—Ç–∞—Ö

### –ö–∞–∂–¥—ã–π —Å–ª–æ–π —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –°–í–û–Æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Handler Tests (HTTP —Å–ª–æ–π)                               ‚îÇ
‚îÇ –¢–µ—Å—Ç–∏—Ä—É—é—Ç: HTTP —Å—Ç–∞—Ç—É—Å—ã, JSON, –≤–∞–ª–∏–¥–∞—Ü–∏—é                ‚îÇ
‚îÇ –ù–ï —Ç–µ—Å—Ç–∏—Ä—É—é—Ç: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, SQL                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Service Tests (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)                           ‚îÇ
‚îÇ –¢–µ—Å—Ç–∏—Ä—É—é—Ç: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é, rollback, –≤–∞–ª–∏–¥–∞—Ü–∏—é             ‚îÇ
‚îÇ –ù–ï —Ç–µ—Å—Ç–∏—Ä—É—é—Ç: —Ä–µ–∞–ª—å–Ω—ã–π SQL, —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –º–æ–∫–∏) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Repository Tests (SQL —Å–ª–æ–π)                             ‚îÇ
‚îÇ –¢–µ—Å—Ç–∏—Ä—É—é—Ç: SQL –∑–∞–ø—Ä–æ—Å—ã, JOIN, –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ        ‚îÇ
‚îÇ –ù–ï —Ç–µ—Å—Ç–∏—Ä—É—é—Ç: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (–æ–Ω–∞ –≤ Service)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—Ä–∏–º–µ—Ä:** –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ø–ª–µ—è

1. **Repository Test** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: SQL INSERT —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
2. **Service Test** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Ñ–∞–π–ª ‚Üí –ë–î ‚Üí rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
3. **Handler Test** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: HTTP 201, JSON –æ—Ç–≤–µ—Ç, –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞

–ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ **—Å–≤–æ–µ–º —Å–ª–æ–µ**, –Ω–µ –¥—É–±–ª–∏—Ä—É—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–≥–∏—Ö —Å–ª–æ–µ–≤.

---

## –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤

### 1. Unit-—Ç–µ—Å—Ç—ã (Services)

**–¶–µ–ª—å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç –º–æ–∫–∏ –¥–ª—è Repository –∏ Storage
- –ù–µ —Ç—Ä–µ–±—É—é—Ç –ë–î –∏–ª–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- –ë—ã—Å—Ç—Ä—ã–µ (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –ª–æ–≥–∏–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏

**–í–∞–∂–Ω–æ:** Unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç **–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É**, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç **—Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É SQL –∏–ª–∏ —Ñ–∞–π–ª–æ–≤**. –î–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å Integration-—Ç–µ—Å—Ç—ã.

**–ü—Ä–∏–º–µ—Ä:**
```go
func TestCreateReplay_DatabaseError(t *testing.T) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ë–î —Ñ–∞–π–ª —É–¥–∞–ª—è–µ—Ç—Å—è (rollback)
    mockStorage.On("SaveReplayFile", ...).Return(filePath, nil)
    mockReplayRepo.On("Create", ...).Return(errors.New("db error"))
    mockStorage.On("DeleteFile", filePath).Return(nil)
    
    replay, err := service.CreateReplay(...)
    
    assert.Error(t, err)
    mockStorage.AssertCalled(t, "DeleteFile", filePath) // Rollback!
}
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–æ–≤ (—Å–Ω–∞—á–∞–ª–∞ —Ñ–∞–π–ª, –ø–æ—Ç–æ–º –ë–î)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –û—Ç–∫–∞—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (rollback)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ùå –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º SQL –∑–∞–ø—Ä–æ—Å—ã
- ‚ùå –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É

### 2. Integration-—Ç–µ—Å—Ç—ã (Repository)

**–¶–µ–ª—å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å PostgreSQL.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç:**
- –ü–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ —Ä–µ–∞–ª—å–Ω–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
- –°–æ–∑–¥–∞—é—Ç –∏ —É–¥–∞–ª—è—é—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ unit-—Ç–µ—Å—Ç–æ–≤ (—Å–µ–∫—É–Ω–¥—ã)
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç SQL –∑–∞–ø—Ä–æ—Å—ã, JOIN, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ PostgreSQL
docker compose up -d postgres

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ—é –ë–î
export TEST_DB_DSN="postgres://user:pass@localhost:5432/test_db"
```

**–ü—Ä–∏–º–µ—Ä:**
```go
func TestReplayRepository_CascadeDelete(t *testing.T) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã —Ä–µ–ø–ª–µ–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ
    game, _ := gameRepo.Create(ctx, userID, "Test Game")
    replay := &models.Replay{...}
    replayRepo.Create(ctx, replay)
    
    gameRepo.Delete(ctx, game.ID, userID)
    
    _, err := replayRepo.GetByID(ctx, replay.ID, userID)
    assert.Error(t, err) // –†–µ–ø–ª–µ–π —É–¥–∞–ª–µ–Ω –∫–∞—Å–∫–∞–¥–Ω–æ!
}
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- ‚úÖ SQL –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ JOIN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (ON DELETE CASCADE)
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (UNIQUE)
- ‚úÖ –õ–∏–º–∏—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
- ‚ùå –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (–æ–Ω–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –≤ Service —Ç–µ—Å—Ç–∞—Ö)

**–ü–æ—á–µ–º—É –Ω–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∑–¥–µ—Å—å?**
Repository –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û –∑–∞ SQL. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–≤–∞–ª–∏–¥–∞—Ü–∏—è, rollback, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è) - —ç—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å Service —Å–ª–æ—è, –∏ –æ–Ω–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `services/*_test.go` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–∫–æ–≤.

**–ü—Ä–æ–ø—É—Å–∫ –≤ CI/CD:**
```go
func TestSomething(t *testing.T) {
    if testing.Short() {
        t.Skip("–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –≤ —Ä–µ–∂–∏–º–µ short")
    }
    // ...
}
```

–ó–∞–ø—É—Å–∫ –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:
```bash
go test -short ./...
```

### 3. HTTP-—Ç–µ—Å—Ç—ã (Handlers)

**–¶–µ–ª—å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å HTTP API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç `httptest` –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–∫–∏ –¥–ª—è Services
- –ù–µ —Ç—Ä–µ–±—É—é—Ç –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç HTTP —Å—Ç–∞—Ç—É—Å—ã, JSON –æ—Ç–≤–µ—Ç—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—é

**–ü—Ä–∏–º–µ—Ä:**
```go
func TestCreateGame_MissingName(t *testing.T) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
    body := map[string]string{} // –ü—É—Å—Ç–æ–π body
    jsonBody, _ := json.Marshal(body)
    
    req, _ := http.NewRequest("POST", "/games", bytes.NewBuffer(jsonBody))
    w := httptest.NewRecorder()
    
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusBadRequest, w.Code)
    assert.Contains(t, response["error"], "name is required")
}
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
- ‚úÖ HTTP —Å—Ç–∞—Ç—É—Å—ã (200, 201, 400, 404, 500)
- ‚úÖ JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚ùå –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- ‚ùå –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ë–î

## –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

### –¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ
go test -cover ./server/internal/...
```

**–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**
- Services: > 80% (–∫—Ä–∏—Ç–∏—á–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
- Repository: > 70% (SQL –∑–∞–ø—Ä–æ—Å—ã)
- Handlers: > 70% (HTTP —Å–ª–æ–π)

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è

```bash
# –°–æ–∑–¥–∞—Ç—å HTML –æ—Ç—á–µ—Ç
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out

# –û—Ç–∫—Ä–æ–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –ø–æ–∫—Ä—ã—Ç–æ–≥–æ/–Ω–µ–ø–æ–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–¥–∞
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω: `Test<Function>_<Scenario>`

```go
‚úÖ TestGetUserGames_Success
‚úÖ TestCreateReplay_DatabaseError
‚úÖ TestDeleteGame_NotFound

‚ùå TestGame
‚ùå TestError
‚ùå Test1
```

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∞ (AAA)

```go
func TestSomething(t *testing.T) {
    // Arrange - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    mockRepo := new(MockRepository)
    service := NewService(mockRepo)
    mockRepo.On("Method", ...).Return(...)
    
    // Act - –¥–µ–π—Å—Ç–≤–∏–µ
    result, err := service.DoSomething()
    
    // Assert - –ø—Ä–æ–≤–µ—Ä–∫–∞
    assert.NoError(t, err)
    assert.Equal(t, expected, result)
    mockRepo.AssertExpectations(t)
}
```

### 3. –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤

- ‚úÖ –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º
- ‚úÖ –¢–µ—Å—Ç—ã –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ
- ‚úÖ –¢–µ—Å—Ç—ã –æ—á–∏—â–∞—é—Ç –∑–∞ —Å–æ–±–æ–π –¥–∞–Ω–Ω—ã–µ
- ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- ‚ùå –ù–µ –∑–∞–≤–∏—Å—å—Ç–µ –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 4. –ú–æ–∫–∏

```go
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–∫–∞
mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.Game")).Return(game, nil)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–∞
mockRepo.AssertCalled(t, "Create", mock.Anything, mock.Anything)

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ù–ï –≤—ã–∑–≤–∞–Ω
mockRepo.AssertNotCalled(t, "Delete")

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –æ–∂–∏–¥–∞–Ω–∏–π
mockRepo.AssertExpectations(t)
```

### 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∫ —É—Å–ø–µ—à–Ω—ã–µ, —Ç–∞–∫ –∏ –æ—à–∏–±–æ—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

```go
‚úÖ TestCreateGame_Success
‚úÖ TestCreateGame_RepositoryError
‚úÖ TestCreateGame_InvalidInput
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π —Å–ª–æ–π

| –ê—Å–ø–µ–∫—Ç | Repository Test | Service Test | Handler Test |
|--------|----------------|--------------|--------------|
| **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç** | –†–µ–∞–ª—å–Ω—É—é –ë–î | –ú–æ–∫–∏ | –ú–æ–∫–∏ |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | –ú–µ–¥–ª–µ–Ω–Ω–æ (—Å–µ–∫—É–Ω–¥—ã) | –ë—ã—Å—Ç—Ä–æ (–º—Å) | –ë—ã—Å—Ç—Ä–æ (–º—Å) |
| **SQL –∑–∞–ø—Ä–æ—Å—ã** | ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç (–º–æ–∫) | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç |
| **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç |
| **HTTP** | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç |
| **Rollback** | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç |
| **JOIN** | ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç | ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç |

**–í—ã–≤–æ–¥:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ **—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è**, –Ω–æ –≤ Service —Ç–µ—Å—Ç–∞—Ö, –∞ –Ω–µ –≤ Repository —Ç–µ—Å—Ç–∞—Ö!

---

## –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

- ‚ùå –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Gin, pgx)
- ‚ùå –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É Go
- ‚ùå –ì–µ—Ç—Ç–µ—Ä—ã/—Å–µ—Ç—Ç–µ—Ä—ã –±–µ–∑ –ª–æ–≥–∏–∫–∏
- ‚ùå –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã

## –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤

### –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ª–æ–≥–∏
go test -v ./...

# –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
go test -v ./server/internal/services -run TestCreateReplay_DatabaseError
```

### –û—Ç–ª–∞–¥–∫–∞ –≤ IDE

–í VS Code –¥–æ–±–∞–≤—å—Ç–µ –≤ `.vscode/launch.json`:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Debug Test",
            "type": "go",
            "request": "launch",
            "mode": "test",
            "program": "${fileDirname}",
            "args": ["-test.run", "TestName"]
        }
    ]
}
```

### –ü—Ä–æ–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```go
// –í—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç
func TestSomething(t *testing.T) {
    t.Skip("TODO: fix this test")
}

// –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤ CI
if os.Getenv("CI") != "" {
    t.Skip("skipping in CI")
}
```

## CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### GitHub Actions

```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.24'
      - run: go test -v -cover ./...
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Testing in Go](https://go.dev/doc/tutorial/add-a-test)
- [Testify Documentation](https://github.com/stretchr/testify)
- [Table-Driven Tests](https://go.dev/wiki/TableDrivenTests)

## –í–æ–ø—Ä–æ—Å—ã?

–ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ë–î –∑–∞–ø—É—â–µ–Ω–∞ (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: `go mod tidy`
3. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à: `go clean -testcache`
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å `-v` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞

