# Руководство по миграции на новую структуру

## Изменения в БД

### Новые поля в таблице `replays`:
- `title` (TEXT, nullable) - название реплея, которое задает пользователь
- `game_name` (TEXT, nullable) - название игры

### Миграция:
```bash
# Применить миграцию
migrate -path server/migrations -database "postgres://..." up
```

## Изменения в коде

### 1. Модель `Replay` (server/internal/models/replay.go)
Добавлены поля:
- `Title *string`
- `GameName *string`

### 2. Репозиторий (server/internal/repository/replay_repository.go)
Обновлены методы:
- `GetAll()` - теперь возвращает title и game_name
- `GetByGame(gameName)` - новый метод для получения реплеев по игре
- `GetGames()` - новый метод для получения списка игр

## Изменения в файловой структуре

### Старая структура:
```
storage/
  └── 2025/
      └── 11/
          └── <id>.rep.gz
```

### Новая структура (рекомендуется):
```
storage/
  ├── dota-2/
  │   ├── <id1>.rep.gz
  │   └── <id2>.rep.gz
  ├── counter-strike/
  │   └── <id3>.rep.gz
  └── unknown/
      └── <id4>.rep.gz
```

### Преимущества новой структуры:
- Логическая группировка по играм
- Легко найти все реплеи конкретной игры
- Легко удалить все реплеи игры
- Простота использования

## Что нужно реализовать дальше

1. **Создать storage service** для работы с файлами:
   - Функция нормализации названия игры
   - Функция генерации пути файла
   - Сохранение файла в правильную папку

2. **Обновить API handlers**:
   - При загрузке принимать `title` и `game_name`
   - Использовать новую структуру путей

3. **Миграция существующих файлов** (если есть):
   - Скрипт для перемещения файлов из старой структуры в новую
   - Обновление путей в БД

## Пример использования в API

### Загрузка реплея:
```json
POST /replays/upload
Content-Type: multipart/form-data

{
  "file": <binary>,
  "title": "Epic comeback",
  "game_name": "Dota 2"
}
```

### Получение реплеев игры:
```
GET /replays?game=dota-2
```

### Получение списка игр:
```
GET /games
```
