# Storage Structure

## Текущая структура

```
storage/
├── {user_id}/
│   ├── {game_id}/
│   │   ├── {replay_id}.ext
│   │   ├── {replay_id}.ext
│   │   └── ...
│   └── {game_id}/
│       └── ...
└── {user_id}/
    └── ...
```

## Пример

```
storage/
├── 00000000-0000-0000-0000-000000000001/
│   ├── aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa/
│   │   ├── 10000000-0000-0000-0000-000000000001.rep
│   │   ├── 10000000-0000-0000-0000-000000000002.rep
│   │   └── c0559cb1-0494-42e4-8939-7b77752d249a.mod
│   └── bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb/
│       └── 10000000-0000-0000-0000-000000000003.rep
└── 11111111-1111-1111-1111-111111111111/
    └── cccccccc-cccc-cccc-cccc-cccccccccccc/
        └── 20000000-0000-0000-0000-000000000001.rep
```

## Преимущества

✅ **Изоляция пользователей** - каждый пользователь имеет свою директорию

✅ **Группировка по играм** - легко найти все реплеи конкретной игры

✅ **Простое удаление** - удаление игры = удаление папки

✅ **Масштабируемость** - структура не зависит от количества реплеев

✅ **Безопасность** - можно настроить права доступа на уровне пользователя

## Путь к файлу

Формат: `storage/{user_id}/{game_id}/{replay_id}{extension}`

Где:
- `user_id` - UUID пользователя
- `game_id` - UUID игры
- `replay_id` - UUID реплея
- `extension` - расширение оригинального файла

## В базе данных

В таблице `replays` хранится относительный путь:

```sql
file_path: "00000000-0000-0000-0000-000000000001/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa/10000000-0000-0000-0000-000000000001.rep"
```

Полный путь формируется как: `{STORAGE_DIR}/{file_path}`

## Управление файлами

### При создании реплея:
1. Создается директория `{user_id}/{game_id}` если не существует
2. Файл сохраняется с именем `{replay_id}{extension}`
3. Путь записывается в БД

### При удалении реплея:
1. Удаляется запись из БД
2. Удаляется файл из storage

### При удалении игры:
1. Получаются все пути файлов реплеев игры
2. Удаляются все файлы
3. Удаляется игра из БД (CASCADE удаляет реплеи)

## Бэкап

### Полный бэкап:
```bash
rsync -av storage/ /backup/replays/
```

### Бэкап конкретного пользователя:
```bash
rsync -av storage/00000000-0000-0000-0000-000000000001/ /backup/user1/
```

### Бэкап конкретной игры:
```bash
rsync -av storage/00000000-0000-0000-0000-000000000001/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa/ /backup/cs2/
```

## Миграция на другой сервер

```bash
# На старом сервере
tar -czf replays-backup.tar.gz storage/

# На новом сервере
tar -xzf replays-backup.tar.gz
chown -R 1000:1000 storage/
```

## Права доступа

Рекомендуемые права:
```bash
storage/              # 755 (rwxr-xr-x)
├── user_id/          # 755 (rwxr-xr-x)
│   └── game_id/      # 755 (rwxr-xr-x)
│       └── file.rep  # 644 (rw-r--r--)
```

Установка:
```bash
chmod -R 755 storage/
find storage/ -type f -exec chmod 644 {} \;
```

## Мониторинг размера

### Общий размер:
```bash
du -sh storage/
```

### По пользователям:
```bash
du -sh storage/*/
```

### По играм конкретного пользователя:
```bash
du -sh storage/00000000-0000-0000-0000-000000000001/*/
```

## Очистка

### Удалить пустые директории:
```bash
find storage/ -type d -empty -delete
```

### Найти большие файлы:
```bash
find storage/ -type f -size +100M
```
